{% extends 'myapp/base.html' %}
{% load static %}

{% block body %}
<div class="text-right mb-4">
    <button onclick="toggleTheme()" class="bg-gray-600 text-white px-4 py-2 rounded">
        üåó Toggle Theme
    </button>
</div>

<div class="container mx-auto p-10">
    <h1 class="text-3xl font-bold mb-5 text-center">Expense Tracker</h1>

<form method="post" class="bg-white p-6 rounded shadow-md w-full max-w-2xl mx-auto mb-6">
    {% csrf_token %}
    <h2 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200">Add New Category</h2>

    <div class="flex gap-2 items-center">
        {{ category_form.name }}
        <button type="submit" name="add_category" class="bg-purple-500 text-white px-4 py-2 rounded">Add Category</button>
    </div>
</form>

    <form method="post" class="bg-white p-6 rounded shadow-md w-full max-w-2xl mx-auto mb-10">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-gray-700 dark:text-gray-200">Name</label>

                {{ expense_form.name }}
            </div>
            <div>
                <label class="block text-gray-700">Amount</label>
                {{ expense_form.amount }}
            </div>
            <div>
                <label class="block text-gray-700">Category</label>
                {{ expense_form.category }}
            </div>
        </div>
        <div class="mt-4 text-center">
            <button type="submit" name="add_expense" class="bg-green-500 text-white px-4 py-2 rounded">Add Expense</button>

        </div>
    </form>

<form method="get" class="bg-white p-4 rounded shadow-md w-full max-w-4xl mx-auto mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-gray-700">Category</label>
            <select name="category" class="w-full border rounded px-2 py-1">
                <option value="all" {% if current_category == "all" %}selected{% endif %}>All</option>
                {% for cat in all_categories %}
                    <option value="{{ cat }}" {% if current_category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-gray-700">Date from</label>
            <input type="date" name="date_from" value="{{ current_from }}" class="w-full border rounded px-2 py-1">
        </div>
        <div>
            <label class="block text-gray-700">Date to</label>
            <input type="date" name="date_to" value="{{ current_to }}" class="w-full border rounded px-2 py-1">
        </div>
        <div class="flex items-end space-x-2">
    <button class="bg-blue-500 text-white px-4 py-2 rounded w-full">Filter</button>
    <a href="{% url 'index' %}" class="bg-gray-400 text-white px-4 py-2 rounded w-full text-center">Reset</a>
</div>
        <div class="text-right max-w-4xl mx-auto my-4">
    <a href="{% url 'export_csv' %}" class="bg-yellow-500 text-white px-4 py-2 rounded">
        üì§ Export to CSV
    </a>
</div>

    </div>
</form>
    <div class="text-right max-w-4xl mx-auto text-lg font-semibold mb-4">
    Total: {{ total_amount }} ‚Ç∏
    </div>
<div class="text-right max-w-4xl mx-auto text-lg font-semibold mb-2">
    –ò—Ç–æ–≥–∏ –∑–∞ –º–µ—Å—è—Ü: {{ monthly_total }} ‚Ç∏
</div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-md w-full max-w-4xl mx-auto">

        <h2 class="text-xl font-semibold mb-4">Expenses</h2>
        <table class="min-w-full table-auto">
            <thead>
                <tr>
                    <th class="px-4 py-2 text-gray-700 dark:text-gray-200">Name</th>
                    <th class="px-4 py-2">Amount</th>
                    <th class="px-4 py-2">Category</th>
                    <th class="px-4 py-2">Date</th>
                    <th class="px-4 py-2">Edit</th>
                    <th class="px-4 py-2">Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr class="bg-gray-100">
                    <td class="border px-4 py-2">{{ expense.name }}</td>
                    <td class="border px-4 py-2">{{ expense.amount }}</td>
                    <td class="border px-4 py-2">{{ expense.category.name }}</td>

                    <td class="border px-4 py-2">{{ expense.date }}</td>
                    <td class="border px-4 py-2 text-center">
                        <a class="text-blue-500 underline" href="{% url 'edit' expense.id %}">Edit</a>
                    </td>
                    <td class="border px-4 py-2 text-center">
                        <a class="text-red-500 underline" href="{% url 'delete' expense.id %}">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">No expenses yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ì–†–ê–§–ò–ö–ò -->
<div class="flex flex-wrap mt-10">
    <div class="w-full md:w-1/2 p-4">
        <h2 class="text-xl font-semibold mb-4">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <canvas id="categoryChart"></canvas>
    </div>
    <div class="w-full md:w-1/2 p-4">
        <h2 class="text-xl font-semibold mb-4">–†–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º</h2>
        <canvas id="dailyChart"></canvas>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const categoryDataRaw = {{ categorical_sums_json|safe }};
    const dailyDataRaw = {{ daily_sums_json|safe }};

    const categoryData = {
        labels: categoryDataRaw.map(item => item.category),
        datasets: [{
            label: '–°—É–º–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
            data: categoryDataRaw.map(item => item.sum),
            backgroundColor: ['#f87171', '#60a5fa', '#fbbf24', '#34d399', '#a78bfa']
        }]
    };

    const dailyData = {
        labels: dailyDataRaw.map(item => item.date),
        datasets: [{
            label: '–°—É–º–º–∞ –ø–æ –¥–Ω—è–º',
            data: dailyDataRaw.map(item => item.sum),
            borderColor: '#3b82f6',
            fill: false,
            tension: 0.1
        }]
    };

    new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: categoryData
    });

    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: dailyData
    });
</script>
    <script>
    function toggleTheme() {
        const html = document.documentElement;
        html.classList.toggle('dark');
        localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }
    });
</script>

{% endblock %}
